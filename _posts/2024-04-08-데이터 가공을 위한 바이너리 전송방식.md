---
key: jekyll-text-theme
title: 'ë°ì´í„° ê°€ê³µì„ ìœ„í•œ Binary ì „ì†¡ë°©ì‹'
excerpt: 'JSON, AVRO ðŸ˜Ž'
tags: [KsqlDB, JSON/AVRO, ë°ì´í„° ê°€ê³µ]
---

# ë°ì´í„° ê°€ê³µì„ ìœ„í•œ ë°”ì´ë„ˆë¦¬ ì „ì†¡ë°©ì‹

* Kafkaì—ì„œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ë•Œ ì§ë ¬í™”(serialize)ë¥¼ í†µí•´ ë°”ì´ë„ˆë¦¬ ë°°ì—´ë¡œ ë³€í™˜í•´ì•¼í•œë‹¤. ê·¸ ì´ìœ ëŠ” ì–´ë–¤ ê°’ì„ ì°¸ì¡°í•˜ëŠ” ì£¼ì†Œê°€ ë‹´ê¸´ ë³€ìˆ˜ë¥¼ ì €ìž¥í•œë‹¤ê³  í–ˆì„ ë•Œ, ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê²Œ ëœë‹¤ê³  í•´ë„ ê°€ë¦¬í‚¤ë˜ ê°’ì˜ ì£¼ì†Œê°€ ë‹¬ë¼ì§€ê¸° ë•Œë¬¸ì— ì˜ë¯¸ê°€ ì—†ê¸° ë•Œë¬¸ìž„. ê·¸ëž˜ì„œ ì°¸ì¡°ê°’ì€ ì €ìž¥í•˜ê±°ë‚˜ ë³´ë‚¼ ìˆ˜ ì—†ê³  ê°’ë§Œ ì €ìž¥í•˜ê±°ë‚˜ ë³´ë‚¼ ìˆ˜ ìžˆë‹¤.

## JSON

* ìŠ¤í‚¤ë§ˆê°€ ë”°ë¡œ ì—†ì´ ìƒì„± ê°€ëŠ¥

* ë°ì´í„°ë¥¼ ë³´ë‚¼ ë•Œ ì „ë¶€ ë³´ë‚´ì•¼í•˜ëŠ” ë¶ˆíŽ¸í•¨ì´ ì¡´ìž¬

### Databaseì˜ source í…Œì´ë¸” ìƒì„±

```
mariaDB> create table udf_test (
id int primary key auto_increment, 
c1 int, 
c2 int, 
c3 int, 
c4 int);
```

### Connector ìƒì„±

```
curl -XPOST http://192.168.2.52:30099/connectors/
{
    "name": "simple-udf",
    "config": {
        "connector.class" : "io.confluent.connect.jdbc.JdbcSourceConnector",
        "connection.url" : "jdbc:mariadb://mariadb:3306/connectTest",
        "connection.user" : "root",
        "connection.password" : "secret",
        "topic.prefix" : "simple_udf_",
        "mode" : "incrementing",
        "incrementing.column.name" : "id",
        "table.whitelist": "udf_test",
        "topic.creation.default.replication.factor" : 2,
        "topic.creation.default.partitions" : 3,
        "poll.interval.ms" : 2000,
        "key.converter": "org.apache.kafka.connect.json.JsonConverter",
        "value.converter": "org.apache.kafka.connect.json.JsonConverter",
        "value.converter.schemas.enable": "false",
        "key.converter.schemas.enable": "false",
        "max.tasks": 1
    }
}
```

###  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ stream ìƒì„±

```
ksql > create stream test1(
id int key,
c1 int,
c2 int,
c3 int,
c4 int
) with (
kafka_topic='simple_udf_udf_test',
value_format='JSON');

ksql> describe  TEST1;

Name                 : TEST1
 Field | Type                   
--------------------------------
 ID    | INTEGER          (key) 
 C1    | INTEGER                
 C2    | INTEGER                
 C3    | INTEGER                
 C4    | INTEGER                
--------------------------------
```

* ë‹¤ë¥¸ streamì„ ì°¸ì¡°í•˜ì—¬ UDFê²°ê³¼ë¥¼ ì €ìž¥í•˜ëŠ” stream ìƒì„±

```
#databseì— ë°ì´í„° insert
MariaDB [connectTest]> insert into udf_test(c1, c2, c3, c4) values(1,2,3,4);
Query OK, 1 row affected (0.00 sec)

MariaDB [connectTest]> insert into udf_test(c1, c2, c3, c4) values(2,3,4,6);
Query OK, 1 row affected (0.02 sec)


#kafka consumerì—ì„œ data í™•ì¸
[kafka@kafka-cluster-kafka-0 bin]$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic simple_udf_udf_test --from-beginning
{"id":17,"c1":1,"c2":2,"c3":3,"c4":4}
{"id":18,"c1":2,"c2":3,"c3":4,"c4":6}

#streamì—ì„œ udf ê²°ê³¼ í™•ì¸
ksql> create stream results AS 
>select TEST_UDF(c1, c2, c3, c4) FROM test2;

 Message                               
---------------------------------------
 Created query with ID CSAS_RESULTS_89 
---------------------------------------
ksql> select * from results EMIT CHANGES;
+-----------------------------------------------------------------------------------------------------------+
|KSQL_COL_0                                                                                                 |
+-----------------------------------------------------------------------------------------------------------+

|2.0                                                                                                        |
|4.0                                                                                                        |

Press CTRL-C to interrupt
```


## AVRO

* schema registryì— schemaë¥¼ ì €ìž¥í•˜ê³  ë°ì´í„°ë¥¼ ì „ì†¡í• ë•Œ schemaì˜ idë§Œ ì§€ì •í•´ì£¼ë©´ ëœë‹¤.

### Databaseì˜ source í…Œì´ë¸” ìƒì„±

```
create table udf_test_avro( 
id int auto_increment primary key, 
c1 int, 
c2 int, 
c3 int, 
c4 int);
```

### Connector ìƒì„±

```
{
    "name": "simple-udf3",
    "config": {
        "connector.class" : "io.confluent.connect.jdbc.JdbcSourceConnector",
        "connection.url" : "jdbc:mariadb://mariadb:3306/connectTest",
        "connection.user" : "root",
        "connection.password" : "secret",
        "topic.prefix" : "simple_udf2_",
        "mode" : "incrementing",
        "incrementing.column.name" : "id",
        "table.whitelist": "udf_test_avro",
        "topic.creation.default.replication.factor" : 2,
        "topic.creation.default.partitions" : 3,
        "poll.interval.ms" : 2000,
        "key.converter": "io.confluent.connect.avro.AvroConverter",
        "value.converter": "io.confluent.connect.avro.AvroConverter",
        "output.format.value": "schema",
        "output.format.key": "schema",
        "key.converter.schema.registry.url": "http://schema-registry:8081",
        "value.converter.schema.registry.url": "http://schema-registry:8081",
        "value.converter.schemas.enable": "false",
        "key.converter.schemas.enable": "false",
        "max.tasks": 1
    }
}
```

### ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ stream ìƒì„±

* AVRO í˜•ì‹ìœ¼ë¡œ í†µì‹ ì„ í•˜ê²Œ ë˜ë©´ streamì˜ key ê°€ ì•„ë‹Œ schema ìžì²´ì˜ idë¡œ êµ¬ë¶„ì„ í•˜ê¸° ë•Œë¬¸ì— keyë¥¼ ì„¤ì •í•´ì¤„ í•„ìš”ê°€ ì—†ìŒ.


```
ksql> create stream avro_test (
>id int,
>c1 int,
>c2 int,
>c3 int,
>c4 int
>) WITH (
>KAFKA_TOPIC='simple_udf2_udf_test_avro',
>VALUE_FORMAT='AVRO'
>);

ksql> describe avro_test;

Name                 : avro_test
 Field | Type                   
--------------------------------
 ID    | INTEGER          
 C1    | INTEGER                
 C2    | INTEGER                
 C3    | INTEGER                
 C4    | INTEGER                
--------------------------------
```

### ë‹¤ë¥¸ streamì„ ì°¸ì¡°í•˜ì—¬ UDFê²°ê³¼ë¥¼ ì €ìž¥í•˜ëŠ” stream ìƒì„±

* Kafka consumerì—ì„œ ë©”ì‹œì§€ í™•ì¸ ì‹œ í˜„ìž¬ kafka clusterì—ëŠ” AVRO deserializeê°€ ì„¤ì¹˜ë˜ì–´ ìžˆì§€ì•Šì•„ ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ìžë¡œ ë³´ì´ê²Œ ëœë‹¤.

* ìœ„ì˜ ë¬¸ì œë¥¼ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•˜ê¸°ì „ì—” ë³¼ ìˆœ ì—†ì§€ë§Œ, kafka topicì—ì„œ `_schema`ë¥¼ í™•ì¸í•œë‹¤ë©´ ì œëŒ€ë¡œ schemaê°€ ìƒì„±ëëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìžˆë‹¤.


```
#ìŠ¤í‚¤ë§ˆ í™•ì¸
[kafka@kafka-cluster-kafka-0 bin]$ ./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic _schemas --from-beginning
{"subject":"test_udf_udf_test-value","version":1,"id":8,"schema":"{\"type\":\"record\",\"name\":\"udf_test\",\"fields\":[{\"name\":\"id\",\"type\":\"int\"},{\"name\":\"c1\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"c2\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"c3\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"c4\",\"type\":[\"null\",\"int\"],\"default\":null}],\"connect.name\":\"udf_test\"}","deleted":false}
{"subject":"simple_udf2_udf_test_avro-value","version":1,"id":9,"schema":"{\"type\":\"record\",\"name\":\"udf_test_avro\",\"fields\":[{\"name\":\"id\",\"type\":\"int\"},{\"name\":\"c1\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"c2\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"c3\",\"type\":[\"null\",\"int\"],\"default\":null},{\"name\":\"c4\",\"type\":[\"null\",\"int\"],\"default\":null}],\"connect.name\":\"udf_test_avro\"}","deleted":false}
{"subject":"AVRO_RESULTS-value","version":1,"id":10,"schema":"{\"type\":\"record\",\"name\":\"KsqlDataSourceSchema\",\"namespace\":\"io.confluent.ksql.avro_schemas\",\"fields\":[{\"name\":\"KSQL_COL_0\",\"type\":[\"null\",\"double\"],\"default\":null}],\"connect.name\":\"io.confluent.ksql.avro_schemas.KsqlDataSourceSchema\"}","deleted":false}
{"subject":"AVRO_RESULTS-value","version":2,"id":11,"schema":"{\"type\":\"record\",\"name\":\"KsqlDataSourceSchema\",\"namespace\":\"io.confluent.ksql.avro_schemas\",\"fields\":[{\"name\":\"KSQL_COL_0\",\"type\":[\"null\",\"double\"],\"default\":null}]}","deleted":false}


#ë°ì´í„° insert
MariaDB [connectTest]> insert into udf_test_avro(c1, c2, c3, c4) values(213,23,56,78);
Query OK, 1 row affected (0.01 sec)

MariaDB [connectTest]> insert into udf_test_avro(c1, c2, c3, c4) values(213,23,59,78);
Query OK, 1 row affected (0.01 sec)


#UDFë¥¼ ì‚¬ìš©í•œ stream ì¡°íšŒ
ksql> select * from avro_results EMIT CHANGES;
+------------------------------------------------------------------------------------------------------+
|KSQL_COL_0                                                                                            |
+------------------------------------------------------------------------------------------------------+
|117.0                                                                                                 |
|115.0   

```