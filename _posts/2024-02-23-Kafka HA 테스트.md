---
key: jekyll-text-theme
title: 'Kafka HA í…ŒìŠ¤íŠ¸'
excerpt: ' Kafka research ğŸ˜'
tags: [Kafka, Research]
---



# Kafka HA í…ŒìŠ¤íŠ¸

## í™˜ê²½ ì„¤ì • (node1 ê¸°ì¤€)


### server.properties

```
broker.id=0
listeners=PLAINTEXT://:9092
advertised.listeners=PLAINTEXT://192.168.0.155:9092
listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL
num.network.threads=3
num.io.threads=8
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
log.dirs=/home/kafka/zookeeper/data
num.partitions=1
num.recovery.threads.per.data.dir=1
offsets.topic.replication.factor=1
transaction.state.log.replication.factor=1
transaction.state.log.min.isr=1
log.retention.hours=48
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
zookeeper.connect=192.168.0.155:2181, 192.168.0.179:2181, 192.168.0.144:2181
zookeeper.connection.timeout.ms=18000
group.initial.rebalance.delay.ms=0
delete.topic.enable=true
```

### zookeeper.properties

```
dataDir=/tmp/zookeeper
clientPort=2181
maxClientCnxns=0
admin.enableServer=false
dataDir=/home/kafka/zookeeper/data
clientPort=2181
maxClientCnxns=0
admin.enableServer=false        
server.1=0.0.0.0:2888:3888
server.2=192.168.0.179:2888:3888
server.3=192.168.0.144:2888:3888
initLimit=5
syncLimit=2
```

## í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ ì‹œ í™•ì¸í•  ì •ë³´

* **offset ë°°ì¹˜** 
	* íŒŒí‹°ì…˜ë‹¹ ê°€ì§€ê³  ìˆëŠ” ë°ì´í„° ìˆ˜ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.

```
$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic --time -1 test-topic:0:1 test-topic:1:6 test-topic:2:3 
```

- **íŒŒí‹°ì…˜ ë°°ì¹˜** 
  íŒŒí‹°ì…˜ ë°°ì¹˜ëŠ” ìƒí™©ì„ í™•ì¸í•˜ê¸° ì¢‹ì€ ìš”ì†Œë¡œ, Leaderê°€ ê³ ë£¨ ë¶„ì‚°ë˜ì–´ ìˆì§€ë§Œ Failover ë°œìƒ ì‹œ ë¦¬ë”ê°€ ë°”ë€Œë¯€ë¡œ í™•ì¸í•˜ê¸° ì‰½ë‹¤.

```
$ bin/kafka-topics.sh --describe --topic test-topic --bootstrap-server localhost:9092
Topic: test-topic	PartitionCount: 3	ReplicationFactor: 2	Configs: 
	Topic: test-topic	Partition: 0	Leader: 1	Replicas: 2,3	Isr: 3,2
	Topic: test-topic	Partition: 1	Leader: 3	Replicas: 3,1	Isr: 3
	Topic: test-topic	Partition: 2	Leader: 2	Replicas: 1,2	Isr: 2
```

## Kafka

### 1 node shutdown

- topic offset : ì¡°íšŒ ì‹œì— ë¬¸ì œëŠ” ì—†ìŒ.

```
$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic --time -1
test-topic:0:1
test-topic:1:6
test-topic:2:3
```

- partition leaderê°€ ë°”ë€Œì–´ì„œ íŒŒí‹°ì…˜ ìì²´ì—ëŠ” ë¬¸ì œê°€ ì—†ì§€ë§Œ Leaderê°€ 1ì¸ íŒŒí‹°ì…˜ì€ ì—†ë‹¤. 
  ì¦‰ Failoverê°€ ì§„í–‰ë˜ì—ˆë‹¤ëŠ” ëœ»ì´ë‹¤.

```
$ bin/kafka-topics.sh --describe --topic test-topic --bootstrap-server localhost:9092
Topic: test-topic	PartitionCount: 3	ReplicationFactor: 2	Configs: 
	Topic: test-topic	Partition: 0	Leader: 2	Replicas: 2,3	Isr: 3,2
	Topic: test-topic	Partition: 1	Leader: 3	Replicas: 3,1	Isr: 3
	Topic: test-topic	Partition: 2	Leader: 2	Replicas: 1,2	Isr: 2
```

### 1 node Shutdownì‹œ ë¡œê·¸ í™•ì¸

- **kafka** 
	* kafka ë…¸ë“œê°€ ì£½ì„ ë• ê°ì partition setì„ ë¶„ë°°í•˜ê³  node 1ì— ìˆë˜ ì…‹ì„ ì œê±°í•˜ëŠ” ì‘ì—…ì´ ë°œìƒí•œë‹¤.

```
### node 2
[2024-02-23 07:47:50,149] INFO [ReplicaFetcherManager on broker 2] 
Removed fetcher for partitions Set(test-topic-2) (kafka.server.ReplicaFetcherManager)

### node 3
[2024-02-23 07:47:50,147] INFO [ReplicaFetcherManager on broker 3] 
Removed fetcher for partitions Set(__consumer_offsets-22, __consumer_offsets-30,...
```

- **zookeeper** : í•´ë‹¹ ë…¸ë“œì—ì„œëŠ” ì¹´í”„ì¹´ ê²½ê³ ê°€ ë°œìƒ

```
[2024-02-23 07:44:05,983] INFO Submitting global closeSession request for session 0x100000e95480002 (org.apache.zookeeper.server.ZooKeeperServer)
[2024-02-23 07:44:51,001] WARN Unable to read additional data from client sessionid 0x100000e95480003, likely client has closed socket (org.apache.zookeeper.server.NIOServerCnxn)
```

- ë‹¤ë¥¸ ë…¸ë“œì—ì„œëŠ” timeoutì´ ë°œìƒí–ˆë‹¤ëŠ” ê±¸ íŒë‹¨í•˜ê³  ì„¸ì…˜ì„ ì •ë¦¬í•œë‹¤.

```
[2024-02-23 07:45:07,751] INFO Expiring session 0x100000e95480003, timeout of 18000ms exceeded (org.apache.zookeeper.server.ZooKeeperServer)
```

### node 1+2 shutdown

- offset ì¡°íšŒ

```
$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic
Error: partition 2 does not have a leader. Skip getting offsets
[2024-02-23 08:04:19,505] WARN [Consumer clientId=GetOffsetShell, groupId=null] 1 partitions have leader brokers without a matching listener, including [test-topic-2] (org.apache.kafka.clients.NetworkClient)
test-topic:0:1
test-topic:1:3
```

- íŒŒí‹°ì…˜ ì¡°íšŒ ì‹œ replica setì´ ì—†ì–´ leaderê°€ ì •í•´ì§€ì§€ ì•Šì•˜ê³ , ê·¸ë˜ì„œ ë¬¸ì œê°€ ìƒê¹€.

```
$ bin/kafka-topics.sh --describe --topic test-topic --bootstrap-server localhost:9092
Topic: test-topic	PartitionCount: 3	ReplicationFactor: 2	Configs: 
	Topic: test-topic	Partition: 0	Leader: 3	Replicas: 2,3	Isr: 3
	Topic: test-topic	Partition: 1	Leader: 3	Replicas: 3,1	Isr: 3
	Topic: test-topic	Partition: 2	Leader: none	Replicas: 1,2	Isr: 2
```

### node 1+2 shutdownì‹œ ë¡œê·¸ í™•ì¸

- **kafka** 
	* offlineì´ ëœ offsetì„ ëª¨ë‘ ì œê±°í•˜ê³  replicaset threadë¥¼ ì…§ë‹¤ìš´ ì²˜ë¦¬í•´ë²„ë¦°ë‹¤.

```
[2024-02-23 07:53:27,345] INFO [GroupMetadataManager brokerId=3] Removed 0 expired offsets in 27 milliseconds. (kafka.coordinator.group.GroupMetadataManager)
[2024-02-23 07:59:42,876] INFO [ReplicaFetcherManager on broker 3] Removed fetcher for partitions Set(__consumer_offsets-22, __consumer_offsets-4, __consumer_offsets-7, __consumer_offsets-46, __consumer_offsets-25, __consumer_offsets-49, __consumer_offsets-16, __consumer_offsets-28, __consumer_offsets-31, __consumer_offsets-37, __consumer_offsets-19, __consumer_offsets-13, __consumer_offsets-43, test-topic-0, __consumer_offsets-1, __consumer_offsets-34, __consumer_offsets-10, __consumer_offsets-40) (kafka.server.ReplicaFetcherManager)
[2024-02-23 07:59:43,415] INFO [ReplicaFetcher replicaId=3, leaderId=2, fetcherId=0] Shutting down (kafka.server.ReplicaFetcherThread)
[2024-02-23 07:59:43,415] INFO [ReplicaFetcher replicaId=3, leaderId=2, fetcherId=0] Stopped (kafka.server.ReplicaFetcherThread)
[2024-02-23 07:59:43,416] INFO [ReplicaFetcher replicaId=3, leaderId=2, fetcherId=0] Shutdown completed (kafka.server.ReplicaFetcherThread)
```

- **zookeeper** 
	* ì˜ì™¸ë¡œ ë™ì¼ ì‹œê°„ì— ë¡œê·¸ê°€ ê±°ì˜ ì—†ë‹¤. 
	* ì£¼í‚¤í¼ë¡œ ì¥ì•  íŒë‹¨ì„ í•˜ê¸°ì—” ë‚œì ì´ ë§ì„ë“¯.

```
[2024-02-23 07:59:59,511] INFO Submitting global closeSession request for session 0x200000de6bd0002 (org.apache.zookeeper.server.ZooKeeperServer)
```

### kill -9 shutdown

- node 1 kill 
	* ë°”ë¡œ ë°˜ì‘í•˜ì§„ ì•Šê³  ì‹œê°„ì´ ì¢€ ê±¸ë¦°ë‹¤. 
	* kafka ë…¸ë“œì—ì„œ íŒŒì•…í•˜ê³  í´ëŸ¬ìŠ¤í„°ì—ì„œ ì œì™¸ëœë‹¤.

```
[2024-02-23 00:53:31,511] INFO [ReplicaFetcherManager on broker 1] Removed fetcher for partitions Set(test-topic-2) (kafka.server.ReplicaFetcherManager)
```

- node 1+2 kill : ë‹¹ì—°íˆ íŒŒí‹°ì…˜ ëª» ì°¾ìŒ.

```
$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic --time -1
Error: partition 2 does not have a leader. Skip getting offsets
[2024-02-23 01:00:45,181] WARN [Consumer clientId=GetOffsetShell, groupId=null] 1 partitions have leader brokers without a matching listener, including [test-topic-2] (org.apache.kafka.clients.NetworkClient)
test-topic:0:16
test-topic:1:24 
```

## zookeeper ê°€ìš©ì„± í…ŒìŠ¤íŠ¸

- **zookeeperëŠ” ë©”íƒ€ê´€ë¦¬ íˆ´ì´ê¸° ë•Œë¬¸ì— ë°ì´í„° ë¡œë“œì—” ë¬¸ì œê°€ ì—†ì–´ì•¼ í•œë‹¤.**

### shutdown

- node 1 shutdown

```
$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic --time -1
test-topic:0:1
test-topic:1:6
test-topic:2:3
```

- node 1+2 shutdown 
	* kafkaëŠ” ì‚´ì•„ìˆìœ¼ë¯€ë¡œ ë¬¸ì œëŠ” ì—†ìŒ, ë‹¨ ë‚¨ì€ í•˜ë‚˜ì˜ Zookeeperì—ì„œ ì—ëŸ¬ê°€ ëœ¸

```
$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic --time -1
test-topic:0:1
test-topic:1:6
test-topic:2:3
```

```
[2024-02-23 08:27:28,483] WARN Cannot open channel to 1 at election address /192.168.0.155:3888 (org.apache.zookeeper.server.quorum.QuorumCnxManager)
```

### kill -9

- node 1 kill : ì£½ì´ëŠ” ì¦‰ì‹œ ë‹¤ë¥¸ ì£¼í‚¤í¼ì—ì„œ íŒŒì•…í•¨

```
[2024-02-23 00:55:45,214] ERROR Unexpected exception causing shutdown while sock still open (org.apache.zookeeper.server.quorum.LearnerHandler) java.io.EOFException at java.base/java.io.DataInputStream.readInt(DataInputStream.java:397) at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:84) at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:86) at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:118) at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:539) [2024-02-23 00:55:45,214] WARN Interrupted while waiting for message on queue (org.apache.zookeeper.server.quorum.QuorumCnxManager) java.lang.InterruptedException at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.reportInterruptAfterWait(AbstractQueuedSynchronizer.java:2056) at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2133) at java.base/java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:432) at org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:1308) at org.apache.zookeeper.server.quorum.QuorumCnxManager.access$700(QuorumCnxManager.java:85) at org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:1143) [2024-02-23 00:55:45,214] WARN Send worker leaving thread  id 1 my id = 3 (org.apache.zookeeper.server.quorum.QuorumCnxManager) [2024-02-23 00:55:45,214] WARN ******* GOODBYE /192.168.0.155:33266 ******** (org.apache.zookeeper.server.quorum.LearnerHandler) [2024-02-23 00:55:45,214] ERROR Unexpected exception causing shutdown while sock still open (org.apache.zookeeper.server.quorum.LearnerHandler)
java.io.EOFException
	at java.base/java.io.DataInputStream.readInt(DataInputStream.java:397)
	at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:84)
	at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:86)
	at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:118)
	at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:539)
[2024-02-23 00:55:45,214] WARN Interrupted while waiting for message on queue (org.apache.zookeeper.server.quorum.QuorumCnxManager)
java.lang.InterruptedException
	at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.reportInterruptAfterWait(AbstractQueuedSynchronizer.java:2056)
	at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2133)
	at java.base/java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:432)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:1308)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.access$700(QuorumCnxManager.java:85)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:1143)
[2024-02-23 00:55:45,214] WARN Send worker leaving thread  id 1 my id = 3 (org.apache.zookeeper.server.quorum.QuorumCnxManager)
[2024-02-23 00:55:45,214] WARN ******* GOODBYE /192.168.0.155:33266 ******** (org.apache.zookeeper.server.quorum.LearnerHandler)
```

- ê¸°ëŠ¥ì—” í° ë¬¸ì œ ì—†ìŒ

```
$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic --time -1
test-topic:0:16
test-topic:1:24
test-topic:2:20
```

- node 2 kill  : ì—ëŸ¬ ë°œìƒ

```
[2024-02-23 01:02:46,103] WARN Cannot open channel to 2 at election address /192.168.0.179:3888 (org.apache.zookeeper.server.quorum.QuorumCnxManager)
java.net.ConnectException: Connection refused (Connection refused)
	at java.base/java.net.PlainSocketImpl.socketConnect(Native Method)
	at java.base/java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:412)
	at java.base/java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:255)
	at java.base/java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:237)
	at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
	at java.base/java.net.Socket.connect(Socket.java:609)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.initiateConnection(QuorumCnxManager.java:373)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager$QuorumConnectionReqThread.run(QuorumCnxManager.java:436)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at java.base/java.lang.Thread.run(Thread.java:829)
```

- ì˜ì™¸ë¡œ ë°ì´í„° ì‚¬ìš©ì—” ë¬¸ì œëŠ” ì—†ì–´ ë³´ì„ 
	* ì¹´í”„ì¹´ ì¸ìŠ¤í„´ìŠ¤ì—ì„œë„ ê³„ì†í•´ì„œ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

```
$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic --time -1
test-topic:0:20
test-topic:1:28
test-topic:2:22
```

## zookeeper+kafka ê°€ìš©ì„± í…ŒìŠ¤íŠ¸

ì–´ì°¨í”¼ ì•ì—ì„œ ë‹¤ í•´ë´¤ìœ¼ë‹ˆ ë…¸ë“œ í•˜ë‚˜ë§Œ í…ŒìŠ¤íŠ¸í•´ë³´ì!

### Shutdown

- node 1 shutdown 
	* í° ë¬¸ì œ ì—†ìŒ, ë‹¨ failover ì‹œê°„ì— í ì›¨ì´íŒ…ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ.

```
[2024-02-23 01:04:51,210] WARN Interrupted while waiting for message on queue (org.apache.zookeeper.server.quorum.QuorumCnxManager)
java.lang.InterruptedException
	at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.reportInterruptAfterWait(AbstractQueuedSynchronizer.java:2056)
	at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2133)
	at java.base/java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:432)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:1308)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.access$700(QuorumCnxManager.java:85)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:1143)
# failover ì „ì— ë“¤ì–´ì˜¨ ì»¨ìŠˆë¨¸ê°€ ì—ëŸ¬ ë°œìƒì‹œí‚´
[2024-02-23 01:04:51,210] WARN Send worker leaving thread  id 1 my id = 3 (org.apache.zookeeper.server.quorum.QuorumCnxManager)
```

### kill -9

- node1 kill 
	* í° ë¬¸ì œëŠ” ì—†ê³  zookeeper failover, kafka failover ìˆœì„œëŒ€ë¡œ ë¨.

```
# zookeeper failover
[2024-02-23 01:08:10,857] WARN ******* GOODBYE /192.168.0.155:44758 ******** (org.apache.zookeeper.server.quorum.LearnerHandler)
[2024-02-23 01:08:10,858] WARN Interrupting SendWorker thread from RecvWorker. sid: 1. myId: 3 (org.apache.zookeeper.server.quorum.QuorumCnxManager)
[2024-02-23 01:08:10,858] WARN Interrupted while waiting for message on queue (org.apache.zookeeper.server.quorum.QuorumCnxManager)
java.lang.InterruptedException
	at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.reportInterruptAfterWait(AbstractQueuedSynchronizer.java:2056)
	at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2133)
	at java.base/java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:432)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.pollSendQueue(QuorumCnxManager.java:1308)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager.access$700(QuorumCnxManager.java:85)
	at org.apache.zookeeper.server.quorum.QuorumCnxManager$SendWorker.run(QuorumCnxManager.java:1143)
[2024-02-23 01:08:10,858] WARN Send worker leaving thread  id 1 my id = 3 (org.apache.zookeeper.server.quorum.QuorumCnxManager)

# kafka failover
[2024-02-23 01:08:13,397] INFO Expiring session 0x300138012d60000, timeout of 18000ms exceeded (org.apache.zookeeper.server.ZooKeeperServer)
[2024-02-23 01:08:13,397] INFO Submitting global closeSession request for session 0x300138012d60000 (org.apache.zookeeper.server.ZooKeeperServer)
```

## ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ

- ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ ì‹œ ì–´ë–¤ ë¡œê·¸ê°€ ë°œìƒí•˜ê³  timeoutì´ ì–´ë–¤ ë¡œê·¸ë¡œ ë°œìƒë˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸

### 1 node ë‹¨ì ˆ

- nodeì˜ interfaceë¥¼ ê·¸ëƒ¥ êº¼ë²„ë¦¬ëŠ” í˜•ì‹ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•´ ë´„.
- ë‹¹ì—°íˆ offsetì´ë‚˜ partitionì—” ë¬¸ì œê°€ ì—†ìŒ.

```
$ bin/kafka-topics.sh --describe --topic test-topic --bootstrap-server localhost:9092
Topic: test-topic	PartitionCount: 3	ReplicationFactor: 2	Configs: 
	Topic: test-topic	Partition: 0	Leader: 2	Replicas: 2,3	Isr: 3,2
	Topic: test-topic	Partition: 1	Leader: 3	Replicas: 3,1	Isr: 3
	Topic: test-topic	Partition: 2	Leader: 2	Replicas: 1,2	Isr: 2
kafka@kafka-2:~/kafka$ bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list localhost:9092 --topic test-topic
test-topic:0:1
test-topic:1:3
test-topic:2:2
```

### 1 node ë‹¨ì ˆ ì‹œ ë¡œê·¸

- kafkaì—ì„œëŠ” ì¼ë°˜ shutdownê³¼ ë¹„ìŠ·í•˜ë‚˜ ë¡œê·¸ëŠ” ì¡°ê¸ˆ ë‹¤ë¥´ê²Œ ì°íŒë‹¤. 
* ì—°ê²° ì‹œ ì„œë¡œ ì‘ë‹µ ê³¼ì •ì„ ê±°ì¹˜ëŠ”ë° í•´ë‹¹ ì‘ë‹µì´ ì˜¤ì§€ ì•Šê³  shutdown ë˜ì—ˆë‹¤ëŠ” ëœ»ìœ¼ë¡œ ë³´ë©´ ë  ê²ƒ ê°™ë‹¤. 
* ê·¸ í›„ offsetì„ ì •ë¦¬í•˜ê³  ë§ˆë¬´ë¦¬.



```
java.io.IOException: Client was shutdown before response was read
	at org.apache.kafka.clients.NetworkClientUtils.sendAndReceive(NetworkClientUtils.java:109)

[2024-02-23 08:14:05,125] INFO [GroupMetadataManager brokerId=2] Finished unloading __consumer_offsets-24. Removed 0 cached offsets and 0 cached groups. (kafka.coordinator.group.GroupMetadataManager)
```

- zookeeperëŠ” ì†Œì¼“ì´ ì—´ë ¤ ìˆìŒì—ë„ ì…§ë‹¤ìš´ ëœê²ƒ ê°™ë‹¤ê³  íŒë‹¨í•¨.

```
[2024-02-23 08:13:53,660] ERROR Unexpected exception causing shutdown while sock still open (org.apache.zookeeper.server.quorum.LearnerHandler)
java.net.SocketTimeoutException: Read timed out
	at java.base/sun.nio.ch.NioSocketImpl.timedRead(NioSocketImpl.java:283)
	at java.base/sun.nio.ch.NioSocketImpl.implRead(NioSocketImpl.java:309)
	at java.base/sun.nio.ch.NioSocketImpl.read(NioSocketImpl.java:350)
	at java.base/sun.nio.ch.NioSocketImpl$1.read(NioSocketImpl.java:803)
	at java.base/java.net.Socket$SocketInputStream.read(Socket.java:966)
	at java.base/java.io.BufferedInputStream.fill(BufferedInputStream.java:244)
	at java.base/java.io.BufferedInputStream.read(BufferedInputStream.java:263)
	at java.base/java.io.DataInputStream.readInt(DataInputStream.java:393)
	at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:84)
	at org.apache.zookeeper.server.quorum.QuorumPacket.deserialize(QuorumPacket.java:86)
	at org.apache.jute.BinaryInputArchive.readRecord(BinaryInputArchive.java:118)
	at org.apache.zookeeper.server.quorum.LearnerHandler.run(LearnerHandler.java:539)
[2024-02-23 08:13:53,661] WARN ******* GOODBYE /10.0.0.220:33288 ******** (org.apache.zookeeper.server.quorum.LearnerHandler)
[2024-02-23 08:14:04,751] INFO Expiring session 0x200000de6bd0005, timeout of 18000ms exceeded (org.apache.zookeeper.server.ZooKeeperServer)
[2024-02-23 08:14:04,751] INFO Submitting global closeSession request for session 0x200000de6bd0005 (org.apache.zookeeper.server.ZooKeeperServer)
```

## 1+2 node ë‹¨ì ˆ

- offset, partition ì „ë¶€ ë¬¸ì œê°€ ìƒê¸´ë‹¤. 
* ì •í™•íˆëŠ” ë¬¸ì œê°€ ìƒê¸´ ê²Œ ì•„ë‹ˆë¼ ì ‘ê·¼í•˜ëŠ” ì„œë²„ê°€ ëª¨ë‘ ì—†ì–´ì ¸ì„œ ì ‘ê·¼ì„ ëª» í•˜ëŠ” ê²ƒì´ë‹¤.

```
### offset
Error while executing topic command : org.apache.kafka.common.errors.TimeoutException: Call(callName=listNodes, deadlineMs=1695111799387, tries=1, nextAllowedTryMs=1695111799535) timed out at 1695111799435 after 1 attempt(s)

### partition
Exception in thread "main" org.apache.kafka.common.errors.TimeoutException: Failed to get offsets by times in 30000ms
```

- kafka ë¡œê·¸ë¥¼ ì‚´í´ë³´ë©´, ë‹¤ë¥¸ kafkaë¥¼ ëª» ì°¾ëŠ”ê±´ ë¬¼ë¡ ì´ê³ , ì•„ì˜ˆ zookeeper ì„œë²„ë¥¼ ëª»ì°¾ëŠ”ë‹¤ê³  ë‚˜ì˜´.

```
[2024-02-23 08:20:33,994] INFO Client session timed out, have not heard from server in 12005ms for sessionid 0x200000de6bd0003, closing socket connection and attempting reconnect (org.apache.zookeeper.ClientCnxn)
[2024-02-23 08:20:34,461] INFO Opening socket connection to server 10.0.0.220/10.0.0.220:2181. Will not attempt to authenticate using SASL (unknown error) (org.apache.zookeeper.ClientCnxn)
[2024-02-23 08:20:34,530] INFO Socket error occurred: 10.0.0.220/10.0.0.220:2181: No route to host (org.apache.zookeeper.ClientCnxn)
[2024-02-23 08:20:34,918] INFO Opening socket connection to server kafka-3/10.0.0.84:2181. Will not attempt to authenticate using SASL (unknown error) (org.apache.zookeeper.ClientCnxn)

[2024-02-23 08:20:53,942] INFO [ReplicaFetcher replicaId=3, leaderId=2, fetcherId=0] Error sending fetch request (sessionId=1656834178, epoch=1834) to node 2: (org.apache.kafka.clients.FetchSessionHandler)
java.io.IOException: Connection to 2 was disconnected before the response was read
```

- zookeeperë¥¼ ì°¾ì•„ë³´ë©´, read timeoutìœ¼ë¡œ ì¸í•´ electionì´ ë¶ˆê°€ëŠ¥í•´ ì„œë²„ ìì²´ê°€ ê°€ë™ì´ ì•ˆ ë˜ê³  ìˆëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆë‹¤.

```
[2024-02-23 08:13:53,660] ERROR Unexpected exception causing shutdown while sock still open (org.apache.zookeeper.server.quorum.LearnerHandler)
java.net.SocketTimeoutException: Read timed out

[2024-02-23 08:20:31,187] INFO Shutdown called (org.apache.zookeeper.server.quorum.Leader)
java.lang.Exception: shutdown Leader! reason: Not sufficient followers synced, only synced with sids: [ [3],[3] ]

[2024-02-23 08:20:59,970] WARN Exception causing close of session 0x0: ZooKeeperServer not running (org.apache.zookeeper.server.NIOServerCnxn)
```

## í…ŒìŠ¤íŠ¸ ì •ë¦¬

* í™€ìˆ˜ instanceì—ì„œ ê³¼ë°˜ ì´ìƒì´ë©´ ë¬¸ì œê°€ ì—†ë‹¤

	- íˆ¬í‘œë¡œ election í•˜ëŠ” ê°œë…ì´ê¸° ë•Œë¬¸ì— ê³¼ë°˜ìˆ˜ëŠ” ìˆì–´ì•¼ í•œë‹¤.
	- zookeeper, kafka ëª¨ë‘ ë¹„ì •ìƒ, ì •ìƒ ì¢…ë£Œì‹œ failover ê°€ëŠ¥í•˜ë‹¤.

* kafka failoverëŠ” ë°”ë¡œ ë˜ì§€ ì•Šê³  ì‹œê°„ì´ ê±¸ë¦°ë‹¤.
### zookeeper.session.timeout.ms

- failoverê°€ ëŠë¦° ì´ìœ . zookeeper-kafka ì‚¬ì´ì˜ ì‘ë‹µ ì‹œê°„ì„ ì •í•˜ê³  ì´ ì‹œê°„ë³´ë‹¤ ê¸¸ê²Œ ê±¸ë¦¬ë©´ zookeeperëŠ” ì¹´í”„ì¹´ ì •ë³´ë¥¼ ì •ë¦¬í•˜ê³  ë‹¤ë¥¸ zookeeperì—ê²Œ fail-over ëª…ë ¹ì„ ì „ë‹¬í•œë‹¤.
- ê¸°ë³¸ì€ 18ì´ˆë¡œ ë‹¤ì†Œ ê¸¸ì§€ë§Œ, data replication ë•Œë¬¸ì— ê¸°ì¡´ 6ì´ˆì—ì„œ 18ì´ˆë¡œ ëŠ˜ë ¸ë‹¤ê³  í•œë‹¤.
- ì°¸ê³  ì‚¬ì´íŠ¸ : session timeoutì„ ê¸°ë³¸ 18ì´ˆë¡œ ë³€ê²½í•œ ì´ìœ ì— ëŒ€í•´ ì„¤ëª…í•¨

ğŸ‘‰ [https://cwiki.apache.org/confluence/display/KAFKA/KIP-537:+Increase+default+zookeeper+session+timeout](https://cwiki.apache.org/confluence/display/KAFKA/KIP-537:+Increase+default+zookeeper+session+timeout)

### replica.lag.time.max.ms

- í† í”½ì˜ íŒŒí‹°ì…˜ì„ ë§Œë“¤ë©´, ê° íŒŒí‹°ì…˜ë§ˆë‹¤ ISRì´ ìƒê¸´ë‹¤. 
	* ì´ ISRì€ íŒ”ë¡œì›Œë“¤ì˜ ëª©ë¡ì´ë¼ê³  í•  ìˆ˜ ìˆìœ¼ë©°, íŒŒí‹°ì…˜ í•˜ë‚˜ê°€ ìˆë‹¤ë©´ ê·¸ íŒŒí‹°ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ë¦¬ë” ë…¸ë“œê°€ ìˆê³ , ë‚˜ë¨¸ì§€ëŠ” ë¦¬ë” ë…¸ë“œê°€ ë¬¸ì œê°€ ìƒê¸°ë©´ ëŒ€ì‹  ì„ ì¶œë˜ì–´ ë°ì´í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì§€ì›í•˜ê²Œ ëœë‹¤.

- íŒ”ë¡œì›Œê°€ ë¦¬ë”ì—ê²Œì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‹œê°„ì´ ì´ í”„ë¡œí¼í‹° ê°’ë³´ë‹¤ ê¸¸ ê²½ìš° íŒ”ë¡œì›ŒëŠ” ISR ëª©ë¡ì—ì„œ ì œê±°ë˜ê³ , ë³µêµ¬ê°€ í•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•˜ê²Œ ëœë‹¤.

- ì´ í”„ë¡œí¼í‹°ëŠ” ì¥ì•  ìƒí™©ì— ë°ì´í„° ì†ì‹¤ì„ ìœ ë°œí•  ìˆ˜ ìˆëŠ”ë°, ì„¤ëª…í•˜ìë©´
	* ë„ˆë¬´ ì§§ì„ ê²½ìš° : íŒ”ë¡œì›Œê°€ ISR ëª©ë¡ì—ì„œ ë„ˆë¬´ ì‰½ê²Œ ì œê±°ë  ìˆ˜ ìˆìŒ
	* ë„ˆë¬´ ê¸¸ ê²½ìš° : ë°ì´í„°ë¥¼ ë‹¤ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆëŠ”ë° ë¦¬ë” ë…¸ë“œê°€ ì£½ì–´ë²„ë¦¬ë©´ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ì‹œê°„ë§Œí¼ ë°ì´í„° ìœ ì‹¤ì´ ë°œìƒ ëœë‹¤.

- ì¦‰ , ì¥ì• ê°€ ë°œìƒí–ˆì„ ê²½ìš° ë°ì´í„° ìœ ì‹¤ì— ì˜í–¥ì„ ë¼ì¹˜ëŠ” í”„ë¡œí¼í‹°ë¼ê³  í•  ìˆ˜ ìˆë‹¤.
