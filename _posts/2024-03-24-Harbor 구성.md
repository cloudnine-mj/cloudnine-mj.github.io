---
key: jekyll-text-theme
title: 'Harbor  êµ¬ì„± ë°©ë²•'
excerpt: 'Airflow ğŸ˜'
tags: [Harbor]
---

# Harbor êµ¬ì„± ë°©ë²•

## Harbor ì„¤ì¹˜


### Helm repo

```
helm repo add harbor https://helm.goharbor.io
```

### value.yaml ì„¤ì •

* ì„œë¹„ìŠ¤ ë…¸ì¶œ

```
expose:
  type: nodePort
  tls:
    enabled: false
    certSource: none
  nodePort:
    name: harbor
    http:
      nodePort: <ip>
    https:
      nodePort: <ip>
```

* external URL ë³€ê²½
	* Openstack ë‚´ë¶€ í…ŒìŠ¤íŠ¸ìš© ì„œë²„

```
externalURL: http://10.0.0.150:30002
```

* persistence claim ë³€ê²½(nfs)

```
persistence:
  enabled: ture
  persistentVolumeClaim:
    registry:
      storageClass: nfs-client 
      accessMode: ReadWriteOnce
```

### ì„¤ì¹˜

* Helm ê¸°ë°˜ìœ¼ë¡œ ì‹¤í–‰

```
helm install harbor -f values.yaml . -n harbor
```

### í™•ì¸

* 30002 í¬íŠ¸ë¡œ ì ‘ì†

```
$ kubectl get pods -n harbor
NAME                                 READY   STATUS    RESTARTS      AGE
harbor-core-7c699498fc-stc5r         1/1     Running   4 (40h ago)   40h
harbor-database-0                    1/1     Running   1 (40h ago)   40h
harbor-jobservice-646659f84b-6rqjc   1/1     Running   0             40h
harbor-nginx-5887d88bc7-pw5qh        1/1     Running   0             40h
harbor-portal-58fb59b8d-2dh5s        1/1     Running   0             40h
harbor-redis-0                       1/1     Running   0             40h
harbor-registry-cccf56d9b-pnqws      2/2     Running   0             40h
harbor-trivy-0                       1/1     Running   0             40h

# kubectl get svc -n harbor
NAME                TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE
harbor              NodePort    10.108.83.162   <none>        80:30002/TCP        40h
harbor-core         ClusterIP   10.108.163.93   <none>        80/TCP              40h
harbor-database     ClusterIP   10.100.28.99    <none>        5432/TCP            40h
harbor-jobservice   ClusterIP   10.105.70.33    <none>        80/TCP              40h
harbor-portal       ClusterIP   10.97.137.31    <none>        80/TCP              40h
harbor-redis        ClusterIP   10.111.53.130   <none>        6379/TCP            40h
harbor-registry     ClusterIP   10.107.17.78    <none>        5000/TCP,8080/TCP   40h
harbor-trivy        ClusterIP   10.99.123.24    <none>        8080/TCP            40h

```

## Push, Pull ì„¤ì •

* ctrì„ k8s baseë¡œ ì“°ë ¤ë©´  ctrì„¤ì •ë„ ë°”ê¾¸ê³ , dockerë¡œ í‘¸ì‹œí•  ê²½ìš° docker ì„¤ì •ë„ ì¶”ê°€í•´ ì¤˜ì•¼ í•¨.

* ê¸°ë³¸ì ìœ¼ë¡œ docker, k8s ë‘˜ë‹¤ ì ‘ê·¼ì„ httpsë¡œ í•˜ê¸° ë•Œë¬¸ì— ì˜¤íˆë ¤ httpë¥¼ ì“°ë ¤ë©´ ì„¤ì •ì„ ë³€ê²½í•´ ì¤˜ì•¼ í•˜ëŠ” ìƒí™© ë°œìƒ.


### docker

* /etc/docker/daemon.json

* ì£¼ë¡œ push ì‹œ ì“°ê²Œ ë¨.

```
{
 "insecure-registries": ["10.0.0.150:30002"]
}
```

### containerd

* /etc/containerd/config.toml

```
[plugins.cri.registry]
    [plugins.cri.registry.mirrors]
        [plugins.cri.registry.mirrors."docker.io"]
            endpoint = ["https://10.0.0.150:30002"]
    [plugins.cri.registry.configs."10.0.0.150:30002".tls]
        insecure_skip_verify = true
```

## Pull ì‹œ deploy, sts ì„¤ì •

* loginìš© ê³„ì •ì„ ë§Œë“¤ì–´ë„ ë˜ê³ , ì¨ë„ ëœë‹¤.

* http ê¸°ë°˜ì´ë¼ ì‚¬ì‹¤ ë³„ í•„ìš”ëŠ” ì—†ìŒ.

* í•´ë‹¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— secret ìƒì„±

```
kubectl create secret docker-registry harbor-secret -n <namespace>\
  --docker-server=10.0.0.150:30002 \
  --docker-username=test \
  --docker-password=********* \
  --docker-email=*****@********.com\
```

* pull ì‹œ ì„¤ì •

```
Containers:
  image: 10.0.0.150:30002/<project>/<image>:<version>
```

## Push ì ˆì°¨

```
REPOSITORY                                           TAG       IMAGE ID       CREATED         SIZE
10.0.0.150:30002/test/testbox                1.28      8c811b4aec35   5 years ago     1.15MB
testbox                                             1.28      8c811b4aec35   5 years ago     1.15MB
```

* docker login

```
docker login http://10.0.0.150:30002 -u test -p **********
```

* ê¸°ì¡´ ì´ë¯¸ì§€ tag ë³€ê²½

```
docker tag testbox:1.28 10.0.0.150:30002/test/testbox:1.28
```

* push

```
docker push 10.0.0.150:30002/test/testbox
```