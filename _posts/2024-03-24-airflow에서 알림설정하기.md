---
key: jekyll-text-theme
title: 'Airflow ì•Œë¦¼ ì„¤ì •í•˜ê¸°'
excerpt: ' Airflowì—ì„œ Slack, Email, Webhook ì•Œë¦¼ ì„¤ì •í•˜ê¸° ğŸ˜'
tags: [Airflow]
---

# Airflow ì•Œë¦¼ ì„¤ì •í•˜ê¸°

## ê°œë…

* AirflowëŠ” Task ì‹¤íŒ¨, ì„±ê³µ, ì¬ì‹œë„ ë“±ì˜ ì´ë²¤íŠ¸ ë°œìƒ ì‹œ ë‹¤ì–‘í•œ ì±„ë„ë¡œ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ìˆìŒ.
* ì½œë°± í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ Slack, Email, Webhook, PagerDuty ë“±ìœ¼ë¡œ ì•Œë¦¼ì„ í†µí•©í•  ìˆ˜ ìˆìŒ.

## ì„¤ì¹˜


```bash
# Slack Provider ì„¤ì¹˜
pip install apache-airflow-providers-slack

# Emailì„ ìœ„í•œ SMTP ì„¤ì • (airflow.cfg)
[smtp]
smtp_host = smtp.gmail.com
smtp_starttls = True
smtp_ssl = False
smtp_user = your-email@gmail.com
smtp_password = your-app-password
smtp_port = 587
smtp_mail_from = airflow@yourcompany.com
```

## ì›ë¦¬

1. **Callback í•¨ìˆ˜**ëŠ” Task ì‹¤í–‰ í›„ ìë™ìœ¼ë¡œ í˜¸ì¶œ
*  `on_failure_callback`: Task ì‹¤íŒ¨ ì‹œ í˜¸ì¶œ
*  `on_success_callback`: Task ì„±ê³µ ì‹œ í˜¸ì¶œ
*  `on_retry_callback`: Task ì¬ì‹œë„ ì‹œ í˜¸ì¶œ
*  `sla_miss_callback`: SLA ë¯¸ì¶©ì¡± ì‹œ í˜¸ì¶œ
2. DAG ë ˆë²¨ ë˜ëŠ” Task ë ˆë²¨ì—ì„œ ì„¤ì • ê°€ëŠ¥í•¨.

## ì‹¤ë¬´ ì˜ˆì œ

### 1. Slack ì•Œë¦¼

```python
from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.providers.slack.operators.slack_webhook import SlackWebhookOperator
from airflow.providers.slack.hooks.slack_webhook import SlackWebhookHook
from datetime import datetime, timedelta
import json

def slack_failure_alert(context):
    """Task ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼"""
    slack_webhook_hook = SlackWebhookHook(
        http_conn_id='slack_webhook',
        message=f"""
:red_circle: *Task Failed*
*DAG*: {context.get('task_instance').dag_id}
*Task*: {context.get('task_instance').task_id}
*Execution Time*: {context.get('execution_date')}
*Log URL*: {context.get('task_instance').log_url}
*Error*: {context.get('exception')}
        """,
        channel='#airflow-alerts',
        username='Airflow Bot',
    )
    slack_webhook_hook.execute()

def slack_success_alert(context):
    """Task ì„±ê³µ ì‹œ Slack ì•Œë¦¼"""
    task_instance = context.get('task_instance')
    execution_date = context.get('execution_date')
    
    # ì¤‘ìš”í•œ Taskë§Œ ì„±ê³µ ì•Œë¦¼
    if task_instance.task_id in ['final_load', 'critical_process']:
        slack_webhook_hook = SlackWebhookHook(
            http_conn_id='slack_webhook',
            message=f"""
:large_green_circle: *Task Succeeded*
*DAG*: {task_instance.dag_id}
*Task*: {task_instance.task_id}
*Execution Time*: {execution_date}
*Duration*: {task_instance.duration}s
            """,
            channel='#airflow-success',
            username='Airflow Bot',
        )
        slack_webhook_hook.execute()

def slack_sla_miss_alert(dag, task_list, blocking_task_list, slas, blocking_tis):
    """SLA ë¯¸ì¶©ì¡± ì‹œ Slack ì•Œë¦¼"""
    slack_webhook_hook = SlackWebhookHook(
        http_conn_id='slack_webhook',
        message=f"""
:warning: *SLA Miss Alert*
*DAG*: {dag.dag_id}
*Tasks*: {', '.join([task.task_id for task in task_list])}
*Blocking Tasks*: {', '.join([ti.task_id for ti in blocking_tis])}
        """,
        channel='#airflow-sla',
        username='Airflow Bot',
    )
    slack_webhook_hook.execute()

# DAG ë ˆë²¨ ê¸°ë³¸ ì„¤ì •
default_args = {
    'owner': 'data-team',
    'start_date': datetime(2024, 1, 1),
    'retries': 2,
    'retry_delay': timedelta(minutes=5),
    'on_failure_callback': slack_failure_alert,
    'sla': timedelta(hours=2),  # SLA ì„¤ì •
}

dag = DAG(
    'slack_notification_example',
    default_args=default_args,
    schedule_interval='@daily',
    catchup=False,
    sla_miss_callback=slack_sla_miss_alert,
)

critical_task = PythonOperator(
    task_id='critical_process',
    python_callable=lambda: print("Processing"),
    on_success_callback=slack_success_alert,  # Task ë ˆë²¨ ì½œë°±
    dag=dag,
)
```

### 2. Email ì•Œë¦¼

```python
from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.operators.email import EmailOperator
from airflow.utils.email import send_email
from datetime import datetime

def custom_email_alert(context):
    """ì»¤ìŠ¤í…€ ì´ë©”ì¼ ì•Œë¦¼"""
    task_instance = context.get('task_instance')
    exception = context.get('exception')
    execution_date = context.get('execution_date')
    log_url = task_instance.log_url
    
    # HTML í˜•ì‹ ì´ë©”ì¼
    html_content = f"""
    <h2 style="color: red;">Task Failed</h2>
    <table border="1" cellpadding="5">
        <tr><th>DAG</th><td>{task_instance.dag_id}</td></tr>
        <tr><th>Task</th><td>{task_instance.task_id}</td></tr>
        <tr><th>Execution Date</th><td>{execution_date}</td></tr>
        <tr><th>Error</th><td>{exception}</td></tr>
        <tr><th>Log</th><td><a href="{log_url}">View Logs</a></td></tr>
    </table>
    """
    
    send_email(
        to=['data-team@company.com', 'oncall@company.com'],
        subject=f'[Airflow Alert] {task_instance.dag_id}.{task_instance.task_id} Failed',
        html_content=html_content,
    )

default_args = {
    'owner': 'data-team',
    'start_date': datetime(2024, 1, 1),
    'email': ['data-team@company.com'],
    'email_on_failure': True,
    'email_on_retry': False,
    'on_failure_callback': custom_email_alert,
}

dag = DAG(
    'email_notification_example',
    default_args=default_args,
    schedule_interval='@daily',
    catchup=False,
)

# EmailOperator ì§ì ‘ ì‚¬ìš©
send_report = EmailOperator(
    task_id='send_daily_report',
    to=['team@company.com'],
    subject='Daily Report - {{ ds }}',
    html_content="""
    <h3>Daily Report</h3>
    <p>Execution Date: {{ ds }}</p>
    <p>Status: Success</p>
    """,
    files=['/tmp/daily_report_{{ ds }}.pdf'],  # ì²¨ë¶€ íŒŒì¼
    dag=dag,
)
```

### 3. Webhook ì•Œë¦¼ (í†µí•© ì•Œë¦¼ ì‹œìŠ¤í…œ)

```python
from airflow import DAG
from airflow.operators.python import PythonOperator
from airflow.hooks.http_hook import HttpHook
from datetime import datetime
import json

def webhook_alert(context, status='failure'):
    """Webhookìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡ (PagerDuty, OpsGenie ë“±)"""
    task_instance = context.get('task_instance')
    exception = context.get('exception')
    
    http_hook = HttpHook(
        method='POST',
        http_conn_id='webhook_alerts'
    )
    
    payload = {
        'service': 'airflow',
        'status': status,
        'severity': 'critical' if status == 'failure' else 'info',
        'dag_id': task_instance.dag_id,
        'task_id': task_instance.task_id,
        'execution_date': str(context.get('execution_date')),
        'log_url': task_instance.log_url,
        'error': str(exception) if exception else None,
        'owner': task_instance.task.owner,
    }
    
    response = http_hook.run(
        endpoint='/alerts',
        data=json.dumps(payload),
        headers={'Content-Type': 'application/json'},
    )
    
    return response

def failure_webhook(context):
    return webhook_alert(context, status='failure')

def success_webhook(context):
    return webhook_alert(context, status='success')

default_args = {
    'owner': 'data-team',
    'start_date': datetime(2024, 1, 1),
    'on_failure_callback': failure_webhook,
}

dag = DAG(
    'webhook_notification_example',
    default_args=default_args,
    schedule_interval='@daily',
    catchup=False,
)
```

### 4. ë‹¤ì¤‘ ì±„ë„ í†µí•© ì•Œë¦¼


```python
def multi_channel_alert(context):
    """ì—¬ëŸ¬ ì±„ë„ë¡œ ë™ì‹œ ì•Œë¦¼"""
    task_instance = context.get('task_instance')
    
    # ì‹¬ê°ë„ íŒë‹¨
    severity = 'critical' if 'critical' in task_instance.dag_id else 'warning'
    
    # 1. Slack ì•Œë¦¼
    try:
        slack_failure_alert(context)
    except Exception as e:
        print(f"Slack notification failed: {e}")
    
    # 2. ì‹¬ê°í•œ ê²½ìš° Email ì¶”ê°€
    if severity == 'critical':
        try:
            custom_email_alert(context)
        except Exception as e:
            print(f"Email notification failed: {e}")
    
    # 3. Webhook (ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ)
    try:
        webhook_alert(context, status='failure')
    except Exception as e:
        print(f"Webhook notification failed: {e}")
    
    # 4. ì—…ë¬´ ì‹œê°„ ì™¸ PagerDuty
    from datetime import datetime
    hour = datetime.now().hour
    if hour < 9 or hour > 18:  # ì—…ë¬´ ì‹œê°„ ì™¸
        try:
            trigger_pagerduty(context)
        except Exception as e:
            print(f"PagerDuty notification failed: {e}")

def trigger_pagerduty(context):
    """PagerDuty ì•Œë¦¼"""
    http_hook = HttpHook(method='POST', http_conn_id='pagerduty')
    
    payload = {
        'routing_key': 'your-integration-key',
        'event_action': 'trigger',
        'payload': {
            'summary': f"Airflow Task Failed: {context['task_instance'].task_id}",
            'severity': 'critical',
            'source': 'airflow',
            'custom_details': {
                'dag_id': context['task_instance'].dag_id,
                'execution_date': str(context['execution_date']),
                'log_url': context['task_instance'].log_url,
            }
        }
    }
    
    http_hook.run(
        endpoint='/v2/enqueue',
        data=json.dumps(payload),
        headers={'Content-Type': 'application/json'},
    )

default_args = {
    'owner': 'data-team',
    'start_date': datetime(2024, 1, 1),
    'on_failure_callback': multi_channel_alert,
}
```

### 5. ì¡°ê±´ë¶€ ì•Œë¦¼


```python
def conditional_alert(context):
    """ì¡°ê±´ì— ë”°ë¼ ì•Œë¦¼ ì „ì†¡"""
    task_instance = context.get('task_instance')
    exception = context.get('exception')
    
    # íŠ¹ì • ì—ëŸ¬ëŠ” ë¬´ì‹œ
    if 'OperationalError' in str(exception) and 'timeout' in str(exception):
        print("Transient error, not alerting")
        return
    
    # ì¬ì‹œë„ ì¤‘ì—ëŠ” ì•Œë¦¼ ì•ˆí•¨
    if task_instance.try_number < task_instance.max_tries:
        print(f"Retry {task_instance.try_number}/{task_instance.max_tries}, not alerting yet")
        return
    
    # ìµœì¢… ì‹¤íŒ¨ë§Œ ì•Œë¦¼
    slack_failure_alert(context)
```

## ì ìš©í•  ë•Œ ê³ ë ¤í–ˆë˜ ì 

1. **ì•Œë¦¼ ìš°ì„ ìˆœìœ„**: ëª¨ë“  ì‹¤íŒ¨ì— ì•Œë¦¼ì„ ë³´ë‚´ë©´ ë§¤ìš° í”¼ê³¤í•¨. ì¤‘ìš”í•œ DAG/Taskë§Œ ì•Œë¦¼í•˜ê±°ë‚˜, ìµœì¢… ì‹¤íŒ¨ ì‹œì—ë§Œ ì•Œë¦¼í•˜ë„ë¡ í•¨.
2. **ì»¨í…ìŠ¤íŠ¸ ì •ë³´**: ë¡œê·¸ URL, ì‹¤í–‰ ì‹œê°„, ì—ëŸ¬ ë©”ì‹œì§€ ë“± ë””ë²„ê¹…ì— í•„ìš”í•œ ì •ë³´ë¥¼ í¬í•¨í•¨.
3. **ì•Œë¦¼ ì±„ë„ ë¶„ë¦¬**: ì¼ë°˜ ì•Œë¦¼ì€ Slack, ê¸´ê¸‰ ì•Œë¦¼ì€ PagerDutyë¡œ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•¨.
4. **Fallback ë©”ì»¤ë‹ˆì¦˜**: í•œ ì±„ë„ì´ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ì±„ë„ë¡œ ì•Œë¦¼ì´ ê°€ë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬í•¨.
5. **í…ŒìŠ¤íŠ¸**: ì•Œë¦¼ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ ì£¼ê¸°ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
