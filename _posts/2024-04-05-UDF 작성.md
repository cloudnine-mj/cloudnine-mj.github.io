---
key: jekyll-text-theme
title: 'KsqlDBì™€ UDFë¥¼ ì‚¬ìš©í•œ ë°ì´í„° ê°€ê³µ'
excerpt: 'UDF ìž‘ì„± ðŸ˜Ž'
tags: [KsqlDB, UDF, ë°ì´í„° ê°€ê³µ]
---

# UDF ìž‘ì„±

* KsqlDBëŠ” ì‚¬ìš©ìž ì •ì˜ í•¨ìˆ˜ UDF(user definition function)ë¥¼ ì§€ì›í•œë‹¤. 

* JAVA hookìœ¼ë¡œ ìž‘ë™í•˜ë©°,  í”„ë¡œì íŠ¸ì˜ JARíŒŒì¼ì„ ksqldb classpathì— ë„£ì–´ì£¼ë©´ ë“±ë¡ì´ ëœë‹¤.

* ì•„ëž˜ì™€ ê°™ì´ gradleì„ ì´ìš©í•œ ê°„ë‹¨í•œ ìˆ˜ì‹ ë©”ì†Œë“œë¥¼ ê°€ì§„ ìžë°” í”„ë¡œì íŠ¸ë¡œ udfë¥¼ ìƒì„±, ë“±ë¡í•´ë³¸ë‹¤.


## build.gradle

```
buildscript {
    repositories {
        mavenCentral()
    }
}

plugins {
    id "java"
}

sourceCompatibility = JavaVersion.VERSION_11
targetCompatibility = JavaVersion.VERSION_11
version = "0.0.1"

repositories {
    mavenCentral()


    maven {
        url "https://packages.confluent.io/maven"
    }
}

dependencies {
    implementation 'io.confluent.ksql:ksql-udf:5.4.11'
    testImplementation 'junit:junit:4.13.2'
}

task copyJar(type: Copy) {
    from jar
    into "extensions/"
}

build.dependsOn copyJar

test {
    testLogging {
        outputs.upToDateWhen { false }
        showStandardStreams = true
        exceptionFormat = "full"
    }
}

//ìž‘ì„± í›„ buildDependents 
```

## udf.java

* @UDFDescription : í´ëž˜ìŠ¤ì— ë‹¨ë‹¤. ì´ UDF ì „ì²´ì— ëŒ€í•œ ë‚´ìš©ì„ ìž‘ì„±í•˜ëŠ” ê³³ì´ë‹¤.

* @Udf : UDFì—ì„œ ì‚¬ìš©ë  ë©”ì„œë“œì— ë‹¨ë‹¤. ksqlDBëŠ” ì´ ì–´ë…¸í…Œì´ì…˜ì´ ë‹¬ë¦° ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤.

* @UdfParameter : @Udf ì–´ë…¸í…Œì´ì…˜ì´ ìžˆëŠ” ë©”ì„œë“œì˜ íŒŒë¼ë©”í„°ì— ë‹¨ë‹¤. ì´ ì–´ë…¸í…Œì´ì…˜ì€ DESCRIBE Functionì„ í–ˆì„ ë•Œ, Variartionì— ë…¸ì¶œë˜ëŠ” ë¶€ë¶„ì´ë‹¤. 

* UDFì— í˜¸ì¶œë  í•¨ìˆ˜ëŠ” ë¬´ì¡°ê±´ public ì´ì–´ì•¼ í•œë‹¤.

* UDFì— í˜¸ì¶œë  í•¨ìˆ˜ëŠ” ë¬´ì¡°ê±´ non static ì´ì–´ì•¼ í•œë‹¤.


```
package org.example;
import io.confluent.ksql.function.udf.Udf;
import io.confluent.ksql.function.udf.UdfDescription;
import io.confluent.ksql.function.udf.UdfParameter;

@UdfDescription(name="test_udf", description = "load test")
public class udf {
    @Udf(description = "load data and simple operation")
    public double test(
            @UdfParameter(value = "test1")
            final int test1,
            @UdfParameter(value = "test2")
            final int test2,
            @UdfParameter(value = "test3")
            final int test3,
            @UdfParameter(value = "test4")
            final int test4) {
        return ((test1 * test2) + (test3 * test4)) / (test2 + test3);
    }
}
```

* build í•˜ì—¬ JAR íŒŒì¼ ìƒì„±

* `KSQLDB CLASSPATH` ë””ë ‰í„°ë¦¬ë¥¼ ë”°ë¡œ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ê¸° ìœ„í•´ PV, PVC ìƒì„±

	* PV ìƒì„±

```
pv-ksqldb.yml

apiVersion: v1
kind: PersistentVolume
metadata:
  namespace: dataplatform
  name: ksqldb-classpath-pv
  labels:
    app: ksqldb-server
spec:
  storageClassName: local-storage
  accessModes:
    - ReadWriteMany
  capacity:
    storage: 10Gi
  hostPath:
    path: /root/ksqldb-plugins
  volumeMode: Filesystem
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ksqldb-plugins-pvc
  namespace: dataplatform
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: local-storage
```

* ë°ì´í„° ì „ì†¡ ì‹œ convertorë¡œ avroë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ schema registry ì„¤ì •, classpath ì„¤ì •

```
ksqldb-server.yml ìˆ˜ì •

apiVersion: apps/v1
kind: Deployment
metadata:
  name: ksqldb-server-pod
  namespace: dataplatform
  labels:
    app: ksqldb-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ksqldb-server
  template:
    metadata:
      labels:
        app: ksqldb-server
    spec:
      securityContext:
        runAsUser: 1000
        fsGroup: 1000
      nodeSelector:
        kubernetes.io/hostname: k8s-worker-1
      containers:
        - name: ksqldb-server
          image: confluentinc/ksqldb-server:latest
          env:
            - name: KSQL_BOOTSTRAP_SERVERS
              value: "kafka-cluster-kafka-bootstrap.dataplatform.svc.cluster.local:9092"
            - name: KSQL_KSQL_CONNECT_URL
              value: "http://10.97.208.94:8083"
            - name: KSQL_KSQL_EXTENSION_DIR
              value: /usr/share/java/ksql-server/
            - name: KSQL_CONFIG_DIR
              value: /etc/ksqldb
            - name: KSQL_LOG4J_OPTS
              value: -Dlog4j.configuration=file:/etc/ksqldb/log4j.properties
            - name: KSQL_KSQL_SCHEMA_REGISTRY_URL
              value: http://schema-registry:8081
          volumeMounts:
            - name: ksqldb-classpath
              mountPath: /usr/share/java/ksql-server/
      volumes:
        - name: ksqldb-classpath
          persistentVolumeClaim:
            claimName: ksqldb-plugins-pvc
```


* build í›„ ìƒì„±ëœ jarë¥¼ classpath (ì›Œì»¤ë…¸ë“œì˜ /root/ksqldb-plugins) ë¡œ ì´ë™ í›„ ksqldbì— ì ‘ì†í•´ í™•ì¸í•¨.

```
ksql> show functions;

 Function Name         | Category           
--------------------------------------------
....

 AS_VALUE              | OTHER              
 GEO_DISTANCE          | OTHER              
 TEST_UDF              | OTHER              
                       |                    
 REGEXP_EXTRACT        | REGULAR EXPRESSION 
 REGEXP_EXTRACT_ALL    | REGULAR EXPRESSION 
 REGEXP_REPLACE        | REGULAR EXPRESSION 
 REGEXP_SPLIT_TO_ARRAY | REGULAR EXPRESSION 
                       |                    
....

```

* ìœ„ functionë“¤ ì¤‘ categoryê°€ otherì¸ TEST_UDFë¥¼ ë³¼ ìˆ˜ ìžˆëŠ”ë° `ë©”ì†Œë“œëª…_í´ëž˜ìŠ¤ëª…` ìœ¼ë¡œ funtionì´ë¦„ì´ ì§€ì–´ì§„ë‹¤. ìœ„ udfë¥¼ ìžì„¸ížˆ ë³´ë©´ ì•„ëž˜ì™€ ê°™ë‹¤.

```
ksql> describe function test_udf;

Name        : TEST_UDF
Overview    : load test
Type        : SCALAR
Jar         : /usr/share/java/ksql-server/testudf.jar
Variations  : 

	Variation   : TEST_UDF(test1 INT, test2 INT, test3 INT, test4 INT)
	Returns     : DOUBLE
	Description : load data and simple operation
```